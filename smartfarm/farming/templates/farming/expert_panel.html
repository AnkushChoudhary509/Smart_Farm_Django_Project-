{% extends 'farming/base.html' %}
{% block title %}Expert Panel â€” Smart Farming{% endblock %}
{% block extra_css %}
<style>
.ep-wrap{max-width:1200px;margin:0 auto;padding:2rem;}
.ep-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem;}
.ep-stat{background:white;border-radius:14px;padding:1.25rem;box-shadow:0 2px 12px rgba(0,0,0,.06);text-align:center;border-top:4px solid #22c55e;}
.ep-stat-val{font-family:'Playfair Display',serif;font-size:2.2rem;color:#1a3a2a;font-weight:700;}
.ep-stat-lbl{font-size:.78rem;color:#64748b;margin-top:.2rem;}
.ep-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem;}
.ep-card{background:white;border-radius:16px;padding:1.5rem;box-shadow:0 2px 12px rgba(0,0,0,.06);}
.ep-card h3{font-family:'Playfair Display',serif;color:#1a3a2a;margin-bottom:1rem;font-size:1.1rem;}
/* SMS FORM */
.sms-form label{display:block;font-size:.82rem;font-weight:600;color:#1a3a2a;margin-bottom:.3rem;margin-top:.75rem;}
.sms-form input,.sms-form select,.sms-form textarea{width:100%;padding:9px 13px;border:1.5px solid #e2e8f0;border-radius:9px;font-size:.86rem;font-family:'DM Sans',sans-serif;outline:none;}
.sms-form input:focus,.sms-form select:focus,.sms-form textarea:focus{border-color:#22c55e;}
.sms-form textarea{min-height:90px;resize:vertical;line-height:1.6;}
.sms-btn{width:100%;padding:12px;background:linear-gradient(135deg,#1a3a2a,#2d6a4f);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;margin-top:.75rem;font-size:.9rem;}
.sms-btn:hover{opacity:.9;}
.char-count{font-size:.72rem;color:#94a3b8;text-align:right;margin-top:.2rem;}
/* QUERIES */
.query-item{border:1px solid #f1f5f9;border-radius:12px;padding:1rem;margin-bottom:.75rem;}
.query-item h4{font-size:.9rem;color:#1a3a2a;margin-bottom:.3rem;}
.query-item p{font-size:.82rem;color:#475569;margin-bottom:.5rem;line-height:1.6;}
.qi-meta{font-size:.72rem;color:#94a3b8;margin-bottom:.5rem;}
.answer-form textarea{width:100%;padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:.82rem;font-family:'DM Sans',sans-serif;min-height:70px;resize:vertical;outline:none;margin-top:.4rem;}
.answer-form textarea:focus{border-color:#22c55e;}
.answer-btn{padding:7px 18px;background:#1a3a2a;color:white;border:none;border-radius:8px;cursor:pointer;font-size:.8rem;font-weight:600;margin-top:.4rem;}
/* SMS LOG */
.sms-log-item{display:flex;align-items:center;gap:.75rem;padding:.6rem 0;border-bottom:1px solid #f1f5f9;}
.sms-badge{padding:2px 8px;border-radius:6px;font-size:.68rem;font-weight:700;}
.badge-sent{background:#dcfce7;color:#14532d;}
.badge-failed{background:#fee2e2;color:#991b1b;}
.badge-pending{background:#fef3c7;color:#92400e;}
/* FARMERS LIST */
.farmer-chip{display:inline-flex;align-items:center;gap:.4rem;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:4px 10px;font-size:.75rem;margin:.2rem;}
/* API KEY NOTE */
.api-note{background:#fffbeb;border:1px solid #fcd34d;border-radius:10px;padding:.85rem 1.1rem;font-size:.8rem;color:#78350f;margin-top:.75rem;}
.api-note a{color:#92400e;font-weight:600;}
@media(max-width:768px){.ep-grid{grid-template-columns:1fr}.ep-stats{grid-template-columns:1fr 1fr}}
</style>
{% endblock %}
{% block content %}
<div class="page-header"><h1>ğŸ›ï¸ Expert Panel</h1><p>Welcome, {{ expert_name }} â€” answer queries, send SMS alerts, manage farmer chats</p></div>
{% if messages %}{% for m in messages %}
<div style="max-width:1200px;margin:.5rem auto 0;padding:0 2rem;">
  <div style="background:{% if 'successfully' in m.message or 'saved' in m.message %}#f0fdf4;border:1px solid #22c55e;color:#14532d{% else %}#fff7ed;border:1px solid #fb923c;color:#9a3412{% endif %};border-radius:10px;padding:.75rem 1.1rem;font-size:.85rem;">{{ m }}</div>
</div>
{% endfor %}{% endif %}
<div class="ep-wrap">

  <!-- STATS -->
  <div class="ep-stats">
    <div class="ep-stat"><div class="ep-stat-val">{{ farmer_count }}</div><div class="ep-stat-lbl">Registered Farmers</div></div>
    <div class="ep-stat"><div class="ep-stat-val">{{ queries|length }}</div><div class="ep-stat-lbl">Pending Queries</div></div>
    <div class="ep-stat"><div class="ep-stat-val">{{ rooms|length }}</div><div class="ep-stat-lbl">Active Chats</div></div>
    <div class="ep-stat"><div class="ep-stat-val">{{ alerts|length }}</div><div class="ep-stat-lbl">SMS Alerts Sent</div></div>
  </div>

  <div class="ep-grid">

    <!-- SMS ALERT FORM -->
    <div class="ep-card">
      <h3>ğŸ“± Send SMS Alert to Farmers</h3>
      {% if sms_key_configured %}
      <div style="background:#f0fdf4;border:1px solid #22c55e;border-radius:10px;padding:.65rem 1rem;font-size:.81rem;color:#14532d;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;">
        âœ… <strong>Fast2SMS API connected.</strong> SMS will fire immediately on submit.
      </div>
      {% else %}
      <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:.65rem 1rem;font-size:.81rem;color:#dc2626;margin-bottom:1rem;">
        âŒ <strong>FAST2SMS_API_KEY not set in settings.py.</strong> SMS will not be sent until you add it.
      </div>
      {% endif %}
      <form class="sms-form" method="POST" action="{% url 'send_sms_alert' %}">
        {% csrf_token %}
        <label>Alert Title</label>
        <input type="text" name="title" placeholder="e.g. Heavy Rain Warning â€” Spray Suspension" required maxlength="60">
        <label>Message <span style="font-weight:400;color:#94a3b8;" id="smsCharCount">0/160</span></label>
        <textarea name="message" id="smsMsg" placeholder="Type your advisory message here..." maxlength="160"
          oninput="document.getElementById('smsCharCount').textContent=this.value.length+'/160'" required></textarea>

        <!-- HOW TO SEND SECTION -->
        <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:12px;padding:1rem;margin-top:.8rem;">
          <div style="font-weight:700;font-size:.82rem;color:#78350f;margin-bottom:.6rem;">ğŸ“‹ How to Send â€” Choose One:</div>

          <div style="margin-bottom:.75rem;">
            <label style="margin-bottom:.25rem;color:#1a3a2a;">Option A â€” Send to Registered Farmers</label>
            <select name="target" id="targetSelect" onchange="toggleCustom(this.value)">
              <option value="all">All Registered Farmers ({{ farmer_count }})</option>
              {% for state in states %}<option value="state:{{ state }}">{{ state }} farmers only</option>{% endfor %}
              <option value="crop:wheat">Wheat farmers only</option>
              <option value="crop:rice">Rice farmers only</option>
              <option value="crop:cotton">Cotton farmers only</option>
              <option value="custom">ğŸ“ Enter custom numbers below</option>
            </select>
          </div>

          <div id="customNumBox" style="display:none;">
            <label style="color:#1a3a2a;margin-bottom:.25rem;">Option B â€” Enter Phone Numbers Directly</label>
            <textarea name="custom_numbers" id="customNums"
              placeholder="Enter 10-digit mobile numbers, one per line or comma-separated:&#10;9876543210&#10;9123456789&#10;8765432109"
              style="min-height:80px;font-size:.84rem;" oninput="updateNumCount()"></textarea>
            <div style="font-size:.72rem;color:#78350f;margin-top:.2rem;" id="numCount">0 numbers entered</div>
          </div>
        </div>

        <button type="submit" class="sms-btn" style="margin-top:.9rem;">
          ğŸ“¤ Send SMS Now
        </button>
        <div style="font-size:.72rem;color:#94a3b8;margin-top:.4rem;text-align:center;">
          Numbers are automatically formatted to 10-digit Indian mobile format
        </div>
      </form>
    </div>

    <!-- SMS LOG + REGISTERED FARMERS -->
    <div>
      <div class="ep-card" style="margin-bottom:1rem;">
        <h3>ğŸ“‹ Recent SMS Alerts</h3>
        {% if alerts %}
          {% for a in alerts %}
          <div class="sms-log-item">
            <div style="flex:1;min-width:0;">
              <div style="font-size:.85rem;font-weight:600;color:#1a3a2a;">{{ a.title|truncatechars:40 }}</div>
              <div style="font-size:.72rem;color:#94a3b8;">{{ a.created_at|date:"d M, g:i A" }} Â· {{ a.recipients_count }} farmers Â· {{ a.target }}</div>
            </div>
            <span class="sms-badge badge-{{ a.status }}">{{ a.get_status_display }}</span>
          </div>
          {% endfor %}
        {% else %}
          <p style="color:#94a3b8;font-size:.85rem;">No alerts sent yet.</p>
        {% endif %}
      </div>

      <div class="ep-card">
        <h3>ğŸ§‘â€ğŸŒ¾ Registered Farmers ({{ farmer_count }})</h3>
        <div style="max-height:180px;overflow-y:auto;">
          {% if farmers %}
            {% for f in farmers|slice:":30" %}
            <span class="farmer-chip">{{ f.name }} Â· {{ f.phone }}{% if f.state %} Â· {{ f.state }}{% endif %}</span>
            {% endfor %}
            {% if farmer_count > 30 %}<p style="font-size:.75rem;color:#94a3b8;margin-top:.5rem;">...and {{ farmer_count|add:"-30" }} more</p>{% endif %}
          {% else %}
            <p style="color:#94a3b8;font-size:.85rem;">No farmers registered yet. Share the <a href="{% url 'farmer_register' %}">registration link</a> with farmers.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <!-- PENDING QUERIES -->
  <div class="ep-card" style="margin-bottom:1.5rem;">
    <h3>â“ Pending Farmer Queries ({{ queries|length }})</h3>
    {% if queries %}
      {% for q in queries %}
      <div class="query-item">
        <div class="qi-meta">{{ q.name }} Â· {{ q.email }}{% if q.phone %} Â· {{ q.phone }}{% endif %} Â· {{ q.created_at|date:"d M Y" }} Â· Crop: {{ q.crop }}</div>
        <h4>{{ q.problem|truncatechars:120 }}</h4>
        <form class="answer-form" method="POST" action="{% url 'answer_query' q.pk %}">
          {% csrf_token %}
          <textarea name="answer" placeholder="Type your expert answer here..."></textarea>
          <button type="submit" class="answer-btn">âœ… Send Answer</button>
        </form>
      </div>
      {% endfor %}
    {% else %}
      <p style="color:#94a3b8;">No pending queries. Great work!</p>
    {% endif %}
  </div>

  <!-- ACTIVE CHATS -->
  <div class="ep-card">
    <h3>ğŸ’¬ Active Chat Sessions ({{ rooms|length }})</h3>
    {% if rooms %}
      {% for room in rooms %}
      <div style="display:flex;align-items:center;gap:.75rem;padding:.6rem 0;border-bottom:1px solid #f1f5f9;">
        <div style="font-size:1.4rem;">ğŸ§‘â€ğŸŒ¾</div>
        <div style="flex:1;">
          <div style="font-size:.88rem;font-weight:600;color:#1a3a2a;">{{ room.farmer_name }}{% if room.farmer_phone %} Â· {{ room.farmer_phone }}{% endif %}</div>
          <div style="font-size:.75rem;color:#94a3b8;">{{ room.created_at|date:"d M, g:i A" }}</div>
        </div>
        <a href="{% url 'chat_room' room.id %}?expert=1" style="background:#1a3a2a;color:white;padding:6px 16px;border-radius:8px;text-decoration:none;font-size:.8rem;font-weight:600;">Reply â†’</a>
      </div>
      {% endfor %}
    {% else %}
      <p style="color:#94a3b8;font-size:.85rem;">No active chats.</p>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleCustom(val) {
    var box = document.getElementById('customNumBox');
    var sel = document.getElementById('targetSelect');
    if (val === 'custom') {
        box.style.display = 'block';
        sel.name = '_target_disabled';  // disable the select so custom takes over
    } else {
        box.style.display = 'none';
        sel.name = 'target';
    }
}
function updateNumCount() {
    var raw = document.getElementById('customNums').value;
    var nums = raw.split(/[\n,]+/).map(s => s.trim()).filter(s => s.length > 0);
    document.getElementById('numCount').textContent = nums.length + ' number(s) entered';
}
// Live char count
document.getElementById('smsMsg')?.addEventListener('input', function() {
    document.getElementById('smsCharCount').textContent = this.value.length + '/160';
});
</script>
{% endblock %}
